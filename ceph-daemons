#!/bin/sh
# Start/stop ceph daemons

# if we start up as ./ceph-daemons, assume everything else is in the
# current directory too.
if [ `dirname $0` = "." ] && [ $PWD != "/etc/init.d" ]; then
    BINDIR=.
    LIBDIR=.
    ETCDIR=.
else
    BINDIR=/usr/bin
    LIBDIR=/usr/lib/ceph
    ETCDIR=/etc/ceph
fi

CCONF="$BINDIR/cconf"
startup_conf=$ETCDIR"/startup.conf"

. $LIBDIR/ceph_common.sh

usage_exit() {
    echo "usage: $0 [options] {start|stop|restart} [mon|osd|mds]..."
    printf "\t-c conffile.conf\n"
    printf "\t--valgrind\trun via valgrind\n"
    exit
}

## command line options
options=
valgrind=
localhost=
debug=
restartoncoredump=
monaddr=
allhosts=0

while [[ $1 =~ '-' ]]; do     # FIXME: why not '^-'?
case $1 in
    --valgrind)
	    valgrind=1
	    ;;
    --novalgrind)
	    valgrind=0
	    ;;
    -l | --localhost )
	    localhost=1
	    ;;
    --norestart )
	    restartoncoredump=1
	    ;;
    --restart)
	    restartoncoredump=0
	    ;;
    --allhosts)
	    allhosts=1;
	    ;;
    -m )
	    [ "$2" == "" ] && usage_exit
	    options="$options $1"
	    shift
	    MON_ADDR=$1
	    ;;
    --conf_file | -c)
	    [ "$2" == "" ] && usage_exit
	    options="$options $1"
	    shift
	    startup_conf=$1
	    ;;
    *)
	    echo unrecognized option \'$1\'
	    usage_exit
	    ;;
esac
options="$options $1"
shift
done

command=$1
shift
what="$@"

if [[ $what = "" ]]; then
    # extract list of monitors, mdss, osds defined in startup.conf
    what=`$CCONF -c $startup_conf -l mon | egrep -v '^mon$' ; \
	$CCONF -c $startup_conf -l mds | egrep -v '^mds$' ; \
	$CCONF -c $startup_conf -l osd | egrep -v '^osd$'`
fi

hostname=`hostname | cut -d . -f 1`
for item in $what; do
    type=`echo $item | cut -c 1-3` 

    # this host?
    host=`$CCONF -c $startup_conf -s $item -s $type -s global host`
    ssh=""
    cmd=""
    if [[ $host != "" ]]; then
	#echo host for $item is $host, i am $hostname
	if [[ $host != $hostname ]]; then
	    # skip, unless we're starting remote daemons too
	    if [[ $allhosts -eq 0 ]]; then
		continue;
	    fi

	    # we'll need to ssh into that host
	    ssh="ssh root@$host"
	    cd_path=`$CCONF -c $startup_conf -s $item -s $type -s global "ssh path"`
	fi
    else
	host=$hostname
    fi

    get_conf conf_file "$startup_conf" "conf file" $item $type global
    get_conf mon_addr "$monaddr" "mon addr" $item $type global
    [ "$mon_addr" != "" ] && mon_addr_cmd="-m $mon_addr"
    # extract item-specific options from $startup_conf
    
    if [[ $item =~ "mon" ]]; then
	get_conf mon_data_path "$def_mon_data_path" "mon data path" mon$mon mon global
	get_conf mon_data_file "$def_mon_data_file" "mon data file" mon$mon mon global
	
	cmd="$ssh $cd_path $CEPH_BIN/crun $norestart $valgrind $CEPH_BIN/cmon $mon_data_path/$mon_data_file &"

	echo "cmd=$cmd"
    fi

    if [[ $item =~ "mds" ]]; then
	cmd="$ssh $cd_path $CEPH_BIN/crun $norestart $valgrind $CEPH_BIN/cmds --conf_file $conf_file \
			$mon_addr_cmd &"
	echo cmd=$cmd

    fi

    if [[ $item =~ "osd" ]]; then
	get_conf osd_data "" "osd data" osd$osd osd global
	get_conf osd_journal "" "osd journal" osd$osd osd global
	[ "$osd_journal" != "" ] && osd_journal_cmd="-j $osd_journal" || osd_journal_cmd=""
	cmd="$ssh $cd_path $CEPH_BIN/crun $norestart $valgrind $CEPH_BIN/osd --conf_file $conf_file \
			$mon_addr_cmd $osd_journal_cmd &"
	echo $cmd
    fi

    case "$command" in
	start)
	    echo Starting ceph $item on $host...
            # $cmd
	    ;;
	
	stop)
	    echo Stopping ceph $item on $host...
	    ;;
	
	restart)
	    $0 $options stop $item
	    $0 $options start $item
	    ;;
	
	*)
	    usage_exit
	    ;;
    esac
done

exit 0
