#!/bin/sh

# if we start up as ./mkfs.ceph, assume everything else is in the
# current directory too.
if [ `dirname $0` = "." ] && [ $PWD != "/etc/init.d" ]; then
    BINDIR=.
    LIBDIR=.
    ETCDIR=.
else
    BINDIR=/usr/bin
    LIBDIR=/usr/lib/ceph
    ETCDIR=/etc/ceph
fi

. $LIBDIR/ceph_common.sh

usage_exit() {
    echo "usage: $0 [--allhosts] [-c conffile.conf] [--clobber_old_data] [--mkbtrfs]"
    exit
}

allhosts=0
clobber=""
mkbtrfs=0
numosd=

while [ $# -ge 1 ]; do
case $1 in
    --allhosts)
	    allhosts=1
	    ;;
    --clobber_old_data)
	    clobber="--clobber"
	    ;;
    --mkbtrfs)
	    mkbtrfs=1
	    ;;
    --conf_file | -c)
	    [ "$2" == "" ] && usage_exit
	    shift
	    conf=$1
	    ;;
    --numosd)
	    shift
	    numosd=$1
	    ;;
    *)
	    echo unrecognized option \'$1\'
	    usage_exit
	    ;;
esac
shift
done

get_name_list "$@"

# create the monmap if we're doing mon0
if [[ $what =~ "mon0" ]]; then
    # first, make a list of monitors
    mons=`$CCONF -c $conf -l mon | egrep -v '^mon$' | sort`
    args=""
    for mon in $mons; do
	get_conf addr "" "mon addr" mon0 mon global
	args=$args" --add $addr"
    done

    # build monmap
    monmap="/tmp/monmap.$$"
    $BINDIR/monmaptool --create --clobber $args --print $monmap || exit 1

    # build osdmap
    osdmap="/tmp/osdmap.$$"
    if [[ $numosd = "" ]]; then
	maxosd=`$CCONF -c $conf -l osd | egrep -v '^osd$' | tail -1 | cut -c 4-`
	numosd=$(($maxosd + 1))
	echo max osd in $conf is $maxosd, num osd is $numosd
    fi
    $BINDIR/osdmaptool --clobber --createsimple $numosd $osdmap || exit 1
fi

# create monitors, osds
for name in $what; do
    type=`echo $name | cut -c 1-3`   # e.g. 'mon', if $name is 'mon1'
    num=`echo $name | cut -c 4-`
    sections="$name $type global"

    # what host is this daemon assigned to?
    host=`$CCONF -c $conf -s $name -s $type host`
    ssh=""
    if [[ $host != "" ]]; then
	#echo host for $name is $host, i am $hostname
	if [[ $host != $hostname ]]; then
	    # skip, unless we're starting remote daemons too
	    if [[ $allhosts -eq 0 ]]; then
		continue;
	    fi

	    # we'll need to ssh into that host
	    ssh="ssh root@$host"
	fi
    else
	host=$hostname
    fi

    if [[ $type = "mon" ]]; then
	get_conf mon_path "" "mon data" $sections
	$BINDIR/mkmonfs $clobber $mon_path --mon $num --monmap $monmap --osdmap $osdmap || exit 1
    fi

    if [[ $type = "osd" ]]; then
	get_conf osd_path "" "osd data" $sections
	[[ $ssh != "" ]] && scp $monmap $host:$monmap
	$ssh $BINDIR/cosd --monmap_file $monmap --mkfs_for_osd $num $osd_path || exit 1
    fi

done
